# NestJS with SWC Compiler Plugin Example

This example demonstrates using `@soda-gql/plugin-nestjs` with the SWC compiler plugin for ultra-fast zero-runtime GraphQL transformations.

> **âš ï¸ Current Status (v0.1.0 Pre-release)**: The SWC compiler plugin is in minimal implementation state. It successfully detects `gql.operation.*` calls and establishes transformation infrastructure, but **does not yet perform full AST replacement**. Operations are still evaluated at runtime. See [plugin status documentation](../../docs/status/plugin-nestjs.md) for details.

## Features

**Current Implementation (v0.1.0 pre-release)**:
- âœ… NestJS framework integration
- âœ… SWC compiler plugin infrastructure
- âœ… Detection of `gql.operation.*` calls
- âœ… Artifact loading and caching
- âœ… Fast builds with SWC
- âœ… No webpack dependency required
- âœ… Works with `nest build` command
- âœ… Type-safe GraphQL operations
- â³ **Planned**: Zero-runtime transformation (AST replacement)

## Why SWC?

SWC (Speedy Web Compiler) is a Rust-based compiler that's **20x faster** than TypeScript's compiler. Benefits:

- âš¡ **Extremely fast builds** - Ideal for large projects
- ðŸ”„ **Fast rebuilds** - Great for development
- ðŸš€ **Production ready** - Used by Vercel, Next.js, and more
- â³ **Zero-runtime transformation** - Coming in v0.1.0 final release

## Setup

```bash
# Install dependencies (from root)
bun install

# Generate GraphQL system files
cd examples/nestjs-compiler-swc
bun run codegen

# Generate artifact file
bun run artifact
```

## Usage

### Development Mode

```bash
bun run dev
```

This starts the NestJS development server with SWC's fast compilation.

### Production Build

```bash
# Generate artifact
bun run artifact

# Build with SWC
bun run build

# Start production server
bun run start
```

## Configuration

### nest-cli.json

The SWC compiler plugin is configured in `nest-cli.json`:

```json
{
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "builder": "swc",
    "swcPlugins": [
      [
        "@soda-gql/plugin-nestjs/compiler/swc",
        {
          "artifactPath": "./.cache/soda-gql-artifact.json",
          "mode": "zero-runtime",
          "importIdentifier": "@/graphql-system"
        }
      ]
    ]
  }
}
```

### Plugin Options

Same as the TypeScript compiler plugin:

- **artifactPath** (required): Path to the artifact file
- **mode** (optional): `"runtime"` or `"zero-runtime"` (default: `"runtime"`)
- **importIdentifier** (optional): Import identifier (default: `"@/graphql-system"`)
- **configPath** (optional): Path to soda-gql config file

## Build Performance Comparison

> **Note**: These benchmarks reflect compilation speed only. Zero-runtime transformation performance benefits will be available once AST replacement is implemented.

Typical build times for a medium-sized NestJS project:

| Compiler | Initial Build | Rebuild |
|----------|--------------|---------|
| **SWC** (this example) | ~2s | ~0.5s |
| **TSC** (TypeScript) | ~15s | ~5s |
| **Webpack** | ~25s | ~8s |

*Results may vary based on project size and hardware. Currently measures compilation speed only.*

## Project Structure

Same structure as the TypeScript example:

```
nestjs-compiler-swc/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ graphql/
â”‚   â”‚   â””â”€â”€ operations.ts      # GraphQL operations
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ user.service.ts    # Business logic
â”‚   â”œâ”€â”€ app.controller.ts
â”‚   â”œâ”€â”€ app.module.ts
â”‚   â””â”€â”€ main.ts
â”œâ”€â”€ graphql-system/
â”‚   â””â”€â”€ index.ts               # Generated by codegen
â”œâ”€â”€ schema.graphql
â”œâ”€â”€ nest-cli.json              # SWC plugin configuration
â”œâ”€â”€ soda-gql.config.ts
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

## Workflow

1. **Generate GraphQL System**: `bun run codegen`
2. **Write Operations**: Create operations in `src/graphql/operations.ts`
3. **Generate Artifact**: `bun run artifact`
4. **Build with SWC**: `bun run build`
5. **Run Application**: `bun run start`

## Comparison: TSC vs SWC

> **Current Status**: Both compiler plugins provide detection infrastructure. The comparison below focuses on compilation speed and tooling differences.

### TypeScript Compiler (TSC)

**Use when:**
- âœ… You need maximum compatibility
- âœ… You're using advanced TypeScript features
- âœ… You prefer official TypeScript tooling

### SWC Compiler (This Example)

**Use when:**
- âœ… You want fastest possible builds
- âœ… You have a large codebase
- âœ… Fast iteration is important
- âœ… You're comfortable with Rust-based tooling

**Note**: Both plugins currently provide detection-only implementation. SWC offers faster compilation but may lag behind TSC for cutting-edge TypeScript features.

## Scripts

```json
{
  "codegen": "soda-gql codegen --schema schema.graphql --out graphql-system/index.ts",
  "artifact": "soda-gql builder --mode zero-runtime --entry ./src/**/*.ts --out .cache/soda-gql-artifact.json",
  "build": "nest build",
  "dev": "nest start --watch",
  "start": "node dist/main"
}
```

## Troubleshooting

### SWC Plugin Not Found

Ensure `@soda-gql/plugin-nestjs` is installed with SWC peer dependencies:

```bash
bun add -D @soda-gql/plugin-nestjs @swc/core @swc/types
```

### Build Errors

SWC is strict about syntax. Common issues:

1. **Trailing commas** - SWC may reject some patterns TSC accepts
2. **Decorator syntax** - Ensure `experimentalDecorators` is enabled
3. **Type assertions** - Some edge cases may need adjustments

**Solution**: Check the SWC error message and adjust code accordingly.

### Performance Not as Expected

**Tips for maximum performance:**

1. Use `--skipLibCheck` in `tsconfig.json`
2. Disable source maps in production: `"sourceMap": false`
3. Use `--incremental` for rebuilds
4. Consider parallel builds for monorepos

## Migration from TypeScript Plugin

Switching from TSC to SWC is simple:

```diff
  {
    "compilerOptions": {
-     "builder": "tsc",
-     "plugins": [
+     "builder": "swc",
+     "swcPlugins": [
        [
-         {
-           "name": "@soda-gql/plugin-nestjs/compiler/tsc",
-           "options": { ... }
-         }
+         "@soda-gql/plugin-nestjs/compiler/swc",
+         { ... }
        ]
      ]
    }
  }
```

## Next Steps

- Try the [TypeScript compiler example](../nestjs-compiler-tsc) for comparison
- Try the [webpack example](../nestjs-app) for integrated development
- Explore [SWC configuration](https://swc.rs/docs/configuration/swcrc) for advanced optimization
