# NestJS Plugin Example

This example demonstrates the usage of `@soda-gql/plugin-nestjs` in a NestJS application with webpack integration.

## Features

- ✅ NestJS framework integration
- ✅ Webpack plugin for build-time transformation
- ✅ Artifact file mode for production builds
- ✅ Development mode with error reporting
- ✅ Dependency Injection pattern
- ✅ Type-safe GraphQL operations

## Setup

```bash
# Install dependencies (from root)
bun install

# Generate GraphQL system files
cd examples/nestjs-app
bun run codegen
```

## Usage

### Development Mode

```bash
bun run dev
```

This starts the NestJS development server with hot reload. The soda-gql webpack plugin will:
- Transform `gql.default()` calls at build time
- Report errors in development mode
- Generate artifact file for operation registry

### Production Build

```bash
bun run build
bun run start
```

### Type Checking

From the example directory:
```bash
bun run ../../node_modules/.bin/tsc -b
```

From the root:
```bash
cd ../..
bun typecheck
```

## Project Structure

```
nestjs-app/
├── src/
│   ├── graphql/
│   │   ├── models.ts          # GraphQL model definitions
│   │   ├── slices.ts          # Operation slices
│   │   └── operations.ts      # Composed operations
│   ├── services/
│   │   └── user.service.ts    # Business logic with soda-gql
│   ├── app.module.ts          # NestJS module
│   └── main.ts                # Application entry
├── graphql-system/
│   └── index.ts               # Generated by codegen
├── schema.graphql             # GraphQL schema
├── webpack.config.js          # Webpack + soda-gql plugin
├── nest-cli.json              # NestJS CLI configuration
├── package.json
└── tsconfig.json
```

## Webpack Configuration

The `webpack.config.js` integrates the soda-gql plugin:

```javascript
import { SodaGqlWebpackPlugin } from '@soda-gql/plugin-nestjs/webpack/plugin';

export default function (options, webpack) {
  return {
    ...options,
    plugins: [
      ...options.plugins,
      new SodaGqlWebpackPlugin({
        mode: 'artifact-file',
        artifactPath: '.cache/soda-gql-artifact.json',
      }),
    ],
  };
}
```

### Plugin Modes

1. **artifact-file**: Generates a JSON artifact file with all operations (recommended for production)
2. **runtime**: Registers operations at runtime (suitable for development)

## Key Concepts

### Models

Define reusable GraphQL fragments:

```typescript
export const userModel = gql.default(({ model }) =>
  model.User(
    {},
    ({ f }) => [f.id(), f.name()],
    (selection) => ({ id: selection.id, name: selection.name }),
  ),
);
```

### Slices

Domain-specific queries/mutations:

```typescript
export const userSlice = gql.default(({ slice }, { $ }) =>
  slice.query(
    { variables: [$('id').scalar('ID:!')] },
    ({ f, $ }) => [f.user({ id: $.id })(({ f }) => [f.id()])],
    ({ select }) => select(['$.user'], (result) => result),
  ),
);
```

### Operations

Composable GraphQL operations:

```typescript
export const getUserQuery = gql.default(({ operation }, { $ }) =>
  operation.query(
    {
      operationName: 'GetUser',
      variables: [$('userId').scalar('ID:!')],
    },
    ({ $ }) => ({ user: userSlice.build({ id: $.userId }) }),
  ),
);
```

### Service Integration

Use operations in NestJS services:

```typescript
@Injectable()
export class UserService {
  async getUser(userId: string) {
    // Execute getUserQuery with a GraphQL client
    return await client.query(getUserQuery, { userId });
  }
}
```

## Development Workflow

1. **Define schema** in `schema.graphql`
2. **Run codegen** to generate type-safe GraphQL system
3. **Create models** for data transformations
4. **Define slices** for reusable query fragments
5. **Compose operations** from slices
6. **Use in services** with NestJS DI
7. **Build and run** with webpack transformation

## Troubleshooting

### Type Errors

Ensure codegen has been run:
```bash
bun run codegen
```

### Build Errors

Check webpack.config.js and ensure the plugin is properly configured:
```bash
bun run build
```

### Runtime Errors

Verify artifact file is generated:
```bash
ls -la .cache/soda-gql-artifact.json
```
