{
  "$schema": "https://json-schema.org/draft-07/schema",
  "title": "Soda GQL Monorepo Infrastructure Reference",
  "description": "Structured reference for AI agents working on the soda-gql codebase",
  "version": "1.0.0",
  "lastUpdated": "2025-10-15",

  "workspace": {
    "root": "/Users/whatasoda/workspace/soda-gql",
    "packageManager": "bun",
    "workspaces": ["packages/*", "examples/*"],
    "structure": {
      "packages": "All published npm packages",
      "examples": "Example applications demonstrating usage",
      "tests": "Test suites (unit, integration, fixtures)",
      "scripts": "Build and utility scripts"
    }
  },

  "packageManagement": {
    "exportsSystem": {
      "description": "Custom export synchronization system maintaining consistency between source and package manifests",
      "sourceOfTruth": "exports.json",
      "syncScript": "scripts/sync-exports.ts",
      "generatedManifest": "scripts/generated/exports-manifest.{ts,js}",
      "workflow": [
        "Define exports in packages/<name>/exports.json",
        "Run 'bun run exports:sync'",
        "Script validates source files exist",
        "Generates package.json exports with conditions",
        "Creates manifest for tsdown configuration"
      ],
      "exportConditions": {
        "development": "Points to ./src/ source files (used by tests/examples)",
        "types": "TypeScript declaration files (./dist/*.d.ts)",
        "import": "ESM output (./dist/*.js)",
        "require": "CommonJS output (./dist/*.cjs)",
        "default": "Fallback to ESM"
      },
      "exampleExportsJson": {
        "@soda-gql/plugin-nestjs": {
          ".": "./src/index.ts",
          "./webpack": "./src/webpack/index.ts",
          "./webpack/plugin": "./src/webpack/plugin.ts",
          "./webpack/loader": "./src/webpack/loader.ts"
        }
      }
    },
    "packageStructure": {
      "standard": {
        "src/": "Source code",
        "dist/": "Build output (generated by tsdown)",
        "package.json": "Package manifest (auto-generated exports)",
        "exports.json": "Export definitions (source of truth)",
        "tsconfig.editor.json": "TypeScript editor configuration"
      }
    }
  },

  "buildSystem": {
    "bundler": "tsdown",
    "config": "tsdown.config.ts",
    "entrySource": "scripts/generated/exports-manifest.js",
    "outputFormats": ["esm", "cjs"],
    "features": {
      "dualOutput": "Generates both ESM and CommonJS",
      "sourceMap": true,
      "declarations": true,
      "treeshake": "Disabled for packages with heavy Node.js usage",
      "external": "Host dependencies (webpack, babel) externalized"
    },
    "commands": {
      "build": "bun run build (sync + bundle)",
      "buildWatch": "bun run build:watch",
      "clean": "bun run clean:dist",
      "sync": "bun run exports:sync"
    },
    "configPattern": {
      "description": "Each package configured individually in tsdown.config.ts",
      "example": {
        "name": "@soda-gql/plugin-nestjs",
        "outDir": "packages/plugin-nestjs/dist",
        "entry": "From packageEntries manifest",
        "format": ["esm", "cjs"],
        "platform": "node",
        "target": "node18",
        "external": ["@soda-gql/builder", "webpack", "neverthrow", "zod"]
      }
    }
  },

  "typeSystem": {
    "strategy": "TypeScript project references with composite builds",
    "configurations": {
      "tsconfig.json": {
        "purpose": "Root configuration with project references",
        "extends": "./tsconfig.base.json",
        "compilerOptions": {
          "composite": true,
          "baseUrl": ".",
          "customConditions": ["development"],
          "paths": "Maps all packages to source files"
        },
        "references": "All packages and examples"
      },
      "tsconfig.editor.json": {
        "purpose": "IDE support with incremental compilation",
        "extends": ["./tsconfig.json", "./tsconfig.base.json"],
        "compilerOptions": {
          "composite": true,
          "noEmit": false,
          "outDir": ".typecheck/root",
          "tsBuildInfoFile": ".typecheck/root/tsconfig.tsbuildinfo"
        },
        "output": "Type check results in .typecheck/ directories"
      },
      "tests/tsconfig.typecheck.json": {
        "purpose": "Test fixture type checking",
        "compilerOptions": {
          "moduleResolution": "Bundler",
          "allowImportingTsExtensions": true,
          "strict": false,
          "paths": "Maps packages and test fixtures"
        }
      }
    },
    "moduleResolution": {
      "development": {
        "trigger": "customConditions: ['development']",
        "behavior": "Resolves to ./src/ source files",
        "usedBy": ["tests", "scripts", "examples"],
        "benefit": "No rebuild required for changes"
      },
      "production": {
        "trigger": "No custom conditions",
        "behavior": "Resolves to ./dist/ built files",
        "usedBy": ["Published packages", "Production builds"],
        "requires": "Build step first"
      }
    },
    "pathMapping": {
      "rootLevel": "All packages mapped in root tsconfig.json",
      "exampleLevel": "Each example maps only its dependencies",
      "testLevel": "Tests map packages + fixtures",
      "pattern": "@soda-gql/<name>/*: [./packages/<name>/src/*]"
    },
    "commands": {
      "typecheck": "bun typecheck (or tsc -b)",
      "clean": "rm -rf .typecheck"
    }
  },

  "examples": {
    "babelApp": {
      "location": "examples/babel-app/",
      "purpose": "Demonstrate Babel plugin integration",
      "dependencies": [
        "@soda-gql/core",
        "@soda-gql/runtime",
        "@soda-gql/plugin-babel (dev)"
      ],
      "tsconfig": {
        "references": [
          "../../packages/core/tsconfig.editor.json",
          "../../packages/runtime/tsconfig.editor.json"
        ],
        "paths": {
          "@/graphql-system": ["./graphql-system/index.ts"]
        }
      },
      "moduleResolution": "Workspace dependencies + development condition"
    },
    "nestjsApp": {
      "location": "examples/nestjs-app/",
      "purpose": "Demonstrate webpack plugin/loader integration",
      "dependencies": [
        "@soda-gql/core",
        "@soda-gql/runtime",
        "@soda-gql/plugin-nestjs"
      ],
      "webpackConfig": {
        "loader": {
          "test": "/\\.[jt]sx?$/",
          "enforce": "pre",
          "exclude": "/node_modules/",
          "loader": "@soda-gql/plugin-nestjs/webpack/loader",
          "note": "Runs BEFORE ts-loader to transform TypeScript directly"
        },
        "plugin": "SodaGqlWebpackPlugin",
        "sharedOptions": {
          "mode": "zero-runtime",
          "artifactSource": {
            "source": "artifact-file",
            "path": ".cache/soda-gql-artifact.json"
          }
        }
      },
      "tsconfig": {
        "references": [
          "../../packages/core/tsconfig.editor.json",
          "../../packages/runtime/tsconfig.editor.json",
          "../../packages/plugin-nestjs/tsconfig.editor.json"
        ],
        "paths": {
          "@/graphql-system": ["./graphql-system/index.ts"]
        }
      }
    },
    "commands": {
      "codegenAll": "bun run examples:codegen",
      "setup": "cd examples/<name> && bun install && bun run codegen"
    }
  },

  "testing": {
    "runner": "bun test",
    "config": "bunfig.toml",
    "testRoot": "./tests",
    "organization": {
      "unit": "tests/unit/ - Individual module tests",
      "integration": "tests/integration/ - End-to-end tests",
      "fixtures": "tests/fixtures/ - Test code samples and data",
      "utils": "tests/utils/ - Testing utilities"
    },
    "conventions": {
      "fixtureBasedTesting": {
        "description": "Store test code as .ts fixture files, not inline strings",
        "location": "tests/fixtures/",
        "benefits": [
          "Type-checked by TypeScript",
          "Editor support (autocomplete, refactoring)",
          "Use @ts-expect-error for invalid test cases"
        ],
        "antiPattern": "const source = `import { gql } ...`;",
        "recommended": "const source = await readFile('./fixtures/test/source.ts');"
      },
      "behavioralTesting": {
        "description": "Test behavior (execution results), not implementation (output format)",
        "antiPattern": "expect(code).toContain('gqlRuntime.operation')",
        "recommended": "Execute transformed code and verify runtime behavior",
        "utilities": [
          "__resetRuntimeRegistry() - Clear operation registry",
          "new Bun.Transpiler() - Transpile transformed code",
          "Dynamic imports with cache busting: import(`file://${path}?t=${Date.now()}`)"
        ]
      }
    },
    "typescriptConfig": {
      "file": "tests/tsconfig.typecheck.json",
      "moduleResolution": "Bundler",
      "allowImportingTsExtensions": true,
      "paths": {
        "description": "Maps packages to source and fixtures to test runtime",
        "example": {
          "@soda-gql/core": ["packages/core/src/index.ts"],
          "@/graphql-system": ["tests/fixtures/runtime-app/graphql-system/index.ts"]
        }
      }
    },
    "commands": {
      "runAll": "bun test",
      "runSpecific": "bun test tests/unit/<name>/<file>.test.ts",
      "withDev": "bun --conditions=development test",
      "validate": "bun run validate:tests"
    }
  },

  "developmentWorkflow": {
    "initialSetup": [
      "bun install",
      "bun run fixture:setup",
      "bun run exports:sync",
      "bun run build"
    ],
    "dailyDevelopment": {
      "editingPackages": [
        "Edit files in packages/<name>/src/",
        "Run tests (no build needed - uses source)",
        "bun typecheck",
        "bun run biome:check"
      ],
      "addingExport": [
        "Add entry to packages/<name>/exports.json",
        "bun run exports:sync",
        "bun run build"
      ]
    },
    "creatingPackage": {
      "steps": [
        "mkdir -p packages/<name>/src",
        "Create package.json with name, version, type, sideEffects",
        "Create exports.json with entry points",
        "Create tsconfig.editor.json",
        "Add to root tsconfig.json paths and references",
        "Add to tsconfig.editor.json references",
        "Add to tsdown.config.ts",
        "bun run exports:sync",
        "bun run build"
      ],
      "requiredFiles": [
        "package.json",
        "exports.json",
        "tsconfig.editor.json",
        "src/index.ts"
      ]
    },
    "qualityChecks": {
      "command": "bun run quality",
      "runs": [
        "bun run validate:tests",
        "bun run typecheck",
        "bun run biome:check"
      ]
    },
    "troubleshooting": {
      "typeErrors": "rm -rf .typecheck && bun typecheck",
      "moduleResolution": "Verify customConditions: ['development'] and bun run exports:sync",
      "buildFailures": "bun run clean:dist && bun run exports:sync && bun run build"
    }
  },

  "webpackIntegration": {
    "currentState": {
      "package": "@soda-gql/plugin-nestjs",
      "exports": {
        "./webpack/plugin": "./src/webpack/plugin.ts",
        "./webpack/loader": "./src/webpack/loader.ts"
      }
    },
    "components": {
      "plugin": {
        "location": "packages/plugin-nestjs/src/webpack/plugin.ts",
        "class": "SodaGqlWebpackPlugin",
        "responsibilities": [
          "Orchestrate builder services",
          "Runtime refresh on changes",
          "Diagnostics and reporting",
          "Artifact manifest tracking"
        ]
      },
      "loader": {
        "location": "packages/plugin-nestjs/src/webpack/loader.ts",
        "responsibilities": [
          "Zero-runtime transformation",
          "Babel adapter integration",
          "Runtime cache management"
        ]
      },
      "internal": {
        "diagnostics": "packages/plugin-nestjs/src/internal/diagnostics.ts",
        "manifest": "packages/plugin-nestjs/src/internal/manifest.ts"
      },
      "schemas": {
        "location": "packages/plugin-nestjs/src/schemas/webpack.ts",
        "purpose": "Zod validation for plugin/loader options"
      }
    },
    "extractionPlan": {
      "description": "Extract webpack functionality to new @soda-gql/plugin-webpack package",
      "reason": "webpack integration is generic and reusable beyond NestJS",
      "newPackage": "@soda-gql/plugin-webpack",
      "steps": [
        "Create packages/plugin-webpack scaffold",
        "Move plugin.ts, loader.ts, hooks.ts from plugin-nestjs",
        "Move internal/diagnostics.ts and internal/manifest.ts",
        "Move schemas/webpack.ts to schemas/options.ts",
        "Update log prefixes to '@soda-gql/plugin-webpack'",
        "Create package.json, exports.json, tsconfig.editor.json",
        "Add to root tsconfig paths and references",
        "Add to tsdown.config.ts with webpack externalized",
        "Move tests from tests/unit/plugin-nestjs to tests/unit/plugin-webpack",
        "Update plugin-nestjs to re-export from plugin-webpack",
        "Update examples/nestjs-app imports"
      ],
      "validation": [
        "bun run exports:sync",
        "bun run build",
        "bun test tests/unit/plugin-webpack",
        "bun test tests/unit/plugin-nestjs",
        "bun typecheck",
        "cd examples/nestjs-app && bun run build"
      ]
    }
  },

  "codebasePatterns": {
    "errorHandling": {
      "library": "neverthrow",
      "pattern": "Return Result<T, E> types, never throw",
      "functions": ["ok()", "err()"],
      "avoid": "fromPromise (loses type information)"
    },
    "validation": {
      "library": "zod v4",
      "usage": "Validate external data, configuration"
    },
    "codeOrganization": {
      "noClasses": "No classes for state management",
      "pureFunctions": "Pure functions for testability",
      "minimizeCoupling": "Minimize dependencies between modules"
    },
    "typeSafety": {
      "noAny": "Never use 'any' or 'unknown' directly",
      "genericConstraints": "Use generic constraints instead",
      "suppressionComment": "If 'any' necessary, add suppression comment"
    }
  },

  "commands": {
    "build": {
      "full": "bun run build",
      "watch": "bun run build:watch",
      "clean": "bun run clean:dist"
    },
    "test": {
      "all": "bun test",
      "specific": "bun test <path>",
      "dev": "bun --conditions=development test",
      "validate": "bun run validate:tests"
    },
    "quality": {
      "all": "bun run quality",
      "typecheck": "bun typecheck",
      "lint": "bun run biome:check"
    },
    "exports": {
      "sync": "bun run exports:sync"
    },
    "examples": {
      "codegen": "bun run examples:codegen"
    },
    "fixtures": {
      "setup": "bun run fixture:setup"
    }
  },

  "importantPaths": {
    "configs": {
      "rootTsconfig": "tsconfig.json",
      "editorTsconfig": "tsconfig.editor.json",
      "baseTsconfig": "tsconfig.base.json",
      "testTsconfig": "tests/tsconfig.typecheck.json",
      "tsdownConfig": "tsdown.config.ts",
      "bunConfig": "bunfig.toml"
    },
    "scripts": {
      "syncExports": "scripts/sync-exports.ts",
      "validateTests": "scripts/validate-tests.ts",
      "exportsManifest": "scripts/generated/exports-manifest.{ts,js}"
    },
    "packages": "packages/",
    "examples": "examples/",
    "tests": "tests/",
    "typecheck": ".typecheck/"
  },

  "agentGuidance": {
    "beforeCodeChanges": [
      "Verify understanding of monorepo structure",
      "Check if package exists or needs creation",
      "Understand module resolution (development vs production)",
      "Ensure exports.json is source of truth for exports"
    ],
    "whenCreatingPackage": [
      "Follow package structure pattern",
      "Create all required files",
      "Update root configurations",
      "Run exports:sync before building"
    ],
    "whenEditingCode": [
      "Edit source files (./src/), not dist",
      "Tests run against source via development condition",
      "No build needed for testing during development",
      "Run quality checks before committing"
    ],
    "whenAddingExports": [
      "Edit exports.json (source of truth)",
      "Never manually edit package.json exports",
      "Run exports:sync to regenerate manifests",
      "Rebuild if consumers need dist files"
    ],
    "whenDebugging": {
      "typeErrors": "Check .typecheck/ output, verify project references",
      "moduleResolution": "Verify customConditions and path mappings",
      "buildErrors": "Check tsdown.config.ts and external dependencies",
      "testFailures": "Verify fixture paths and development condition"
    }
  }
}
