name: Publish to npm

on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write

jobs:
  check-publishable:
    runs-on: ubuntu-latest
    outputs:
      can_publish: ${{ steps.check.outputs.can_publish }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            packages/*/package.json
          sparse-checkout-cone-mode: false

      - name: Collect public packages
        id: packages
        run: |
          PACKAGES=()
          for pkg_json in packages/*/package.json; do
            if [ -f "$pkg_json" ]; then
              IS_PRIVATE=$(jq -r '.private // false' "$pkg_json")
              if [ "$IS_PRIVATE" = "false" ]; then
                PKG_NAME=$(basename "$(dirname "$pkg_json")")
                PACKAGES+=("$PKG_NAME")
              fi
            fi
          done
          echo "Found public packages: ${PACKAGES[*]}"
          echo "packages=${PACKAGES[*]}" >> $GITHUB_OUTPUT

      - name: Check npm registry
        id: check
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"

          # Get packages from previous step
          read -ra PACKAGES <<< "${{ steps.packages.outputs.packages }}"

          # Platform-specific packages (checked separately)
          PLATFORM_PACKAGES=(
            "swc-transformer-darwin-arm64"
            "swc-transformer-darwin-x64"
            "swc-transformer-linux-x64-gnu"
            "swc-transformer-linux-x64-musl"
            "swc-transformer-win32-x64-msvc"
          )

          ALL_PUBLISHED=true
          ANY_NEW=false

          echo "Checking packages for version ${VERSION}..."

          for pkg in "${PACKAGES[@]}" "${PLATFORM_PACKAGES[@]}"; do
            if npm view "@soda-gql/${pkg}@${VERSION}" version 2>/dev/null; then
              echo "✓ @soda-gql/${pkg}@${VERSION} is already published"
            else
              echo "✗ @soda-gql/${pkg}@${VERSION} is NOT published"
              ALL_PUBLISHED=false

              # Check if package has ever been published
              if ! npm view "@soda-gql/${pkg}" versions 2>/dev/null; then
                echo "  → This package has NEVER been published (needs OTP)"
                ANY_NEW=true
              fi
            fi
          done

          if [ "$ALL_PUBLISHED" = "true" ]; then
            echo "can_publish=skip" >> $GITHUB_OUTPUT
            echo ""
            echo "=== All packages already published. Nothing to do. ==="
          elif [ "$ANY_NEW" = "true" ]; then
            echo "can_publish=local" >> $GITHUB_OUTPUT
            echo ""
            echo "=== Some packages need initial publish with OTP. ==="
            echo "=== Please run locally: bun publish-local ${{ github.event.release.tag_name }} --otp <code> ==="
          else
            echo "can_publish=ci" >> $GITHUB_OUTPUT
            echo ""
            echo "=== All packages can be published via CI. ==="
          fi

  publish:
    needs: check-publishable
    if: needs.check-publishable.outputs.can_publish == 'ci'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download release artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          gh release download "${VERSION}" --repo "${{ github.repository }}" --pattern "publish-packages-*.tar.gz"
          mkdir -p dist
          tar -xzf publish-packages-*.tar.gz -C dist

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm
        run: |
          for dir in dist/*/; do
            PKG_NAME=$(jq -r '.name' "${dir}package.json")
            PKG_VERSION=$(jq -r '.version' "${dir}package.json")

            # Skip if already published
            if npm view "${PKG_NAME}@${PKG_VERSION}" version 2>/dev/null; then
              echo "Skipping ${PKG_NAME}@${PKG_VERSION} (already published)"
              continue
            fi

            echo "Publishing ${PKG_NAME}@${PKG_VERSION}..."
            cd "$dir"
            npm publish --access public --provenance
            cd -
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  notify-local-required:
    needs: check-publishable
    if: needs.check-publishable.outputs.can_publish == 'local'
    runs-on: ubuntu-latest
    steps:
      - name: Notify local publish required
        run: |
          echo "::warning::Some packages require initial publish with OTP"
          echo "::warning::Please run locally: bun publish-local ${{ github.event.release.tag_name }} --otp <code>"
          exit 0
