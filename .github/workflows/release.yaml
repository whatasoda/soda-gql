name: Release

on:
  push:
    branches: [main]
    paths:
      - "package.json"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.result.outputs.should_release }}
      version: ${{ steps.version.outputs.version }}
      is_dry_run: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 2
          sparse-checkout: |
            package.json
          sparse-checkout-cone-mode: false

      - name: Get version
        id: version
        run: |
          NEW_VERSION=$(jq -r '.version' package.json)
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Check version change (push only)
        if: github.event_name == 'push'
        id: version-check
        run: |
          OLD_VERSION=$(git show HEAD~1:package.json | jq -r '.version' 2>/dev/null || echo "")
          NEW_VERSION="${{ steps.version.outputs.version }}"
          echo "old_version=$OLD_VERSION"
          echo "new_version=$NEW_VERSION"
          if [ "$OLD_VERSION" != "$NEW_VERSION" ] && [ -n "$NEW_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if tag exists (push only)
        if: github.event_name == 'push' && steps.version-check.outputs.changed == 'true'
        id: tag
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          git fetch --tags
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine if should release
        id: result
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # workflow_dispatch always proceeds (dry-run mode)
            echo "should_release=true" >> $GITHUB_OUTPUT
          elif [ "${{ steps.version-check.outputs.changed }}" == "true" ] && [ "${{ steps.tag.outputs.exists }}" != "true" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  validate-versions:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2
        with:
          bun-version-file: .bun-version

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Determine bump type
        id: bump-type
        run: |
          OLD_VERSION=$(git show HEAD~1:package.json | jq -r '.version')
          NEW_VERSION=$(jq -r '.version' package.json)
          IFS='.' read -ra OLD <<< "$OLD_VERSION"
          IFS='.' read -ra NEW <<< "$NEW_VERSION"
          if [ "${OLD[0]}" != "${NEW[0]}" ]; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif [ "${OLD[1]}" != "${NEW[1]}" ]; then
            echo "type=minor" >> $GITHUB_OUTPUT
          else
            echo "type=patch" >> $GITHUB_OUTPUT
          fi
          echo "Detected bump type: $(cat $GITHUB_OUTPUT | grep type | cut -d= -f2)"

      - name: Validate package versions
        run: bun scripts/version-check.ts validate ${{ steps.bump-type.outputs.type }}

  build-native:
    needs: [check-version, validate-versions]
    if: needs.check-version.outputs.should_release == 'true'
    uses: ./.github/workflows/build-native.yaml

  build-packages:
    needs: [check-version, build-native]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=4096
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          path: packages/swc/artifacts

      - uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2
        with:
          bun-version-file: .bun-version

      - run: bun install --frozen-lockfile

      - name: Collect NAPI artifacts
        working-directory: packages/swc
        run: bunx @napi-rs/cli artifacts

      - run: bun quality:prepare
      - run: bun quality
      - run: bun prepublish

      - name: Create release archive
        run: |
          VERSION="v${{ needs.check-version.outputs.version }}"
          tar -czvf "publish-packages-${VERSION}.tar.gz" -C dist .

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: release-archive
          path: publish-packages-*.tar.gz
          retention-days: 1

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: publish-packages
          path: dist/
          retention-days: 90

  create-release:
    needs: [check-version, build-packages]
    if: needs.check-version.outputs.is_dry_run != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: release-archive

      - name: Create and push tag
        run: |
          TAG="v${{ needs.check-version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$TAG"
          git push origin "$TAG"
          echo "Created and pushed tag: $TAG"

      - name: Create draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="v${{ needs.check-version.outputs.version }}"
          gh release create "${VERSION}" \
            --title "${VERSION}" \
            --generate-notes \
            --draft \
            "publish-packages-${VERSION}.tar.gz"
