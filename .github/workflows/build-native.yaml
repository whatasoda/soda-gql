name: Build Native Modules

# NOTE: PR/push triggers disabled to reduce GitHub Actions usage.
# Use workflow_dispatch for manual runs, or workflow_call from release.yaml.
# on:
#   push:
#     branches: [main]
#     paths:
#       - "packages/swc-transformer/**"
#       - ".github/workflows/build-native.yaml"
#   pull_request:
#     paths:
#       - "packages/swc-transformer/**"
#       - ".github/workflows/build-native.yaml"

on:
  workflow_dispatch:
  workflow_call:

env:
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: x86_64-apple-darwin
            name: darwin-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            name: darwin-arm64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: linux-x64-gnu
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            name: linux-x64-musl
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: win32-x64-msvc
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: packages/swc-transformer
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2
        with:
          workspaces: packages/swc-transformer -> target

      - name: Setup musl
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2

      - name: Install dependencies
        run: bun install
        working-directory: .

      - name: Build native module
        run: bunx @napi-rs/cli build --output-dir src/native --platform --release --target ${{ matrix.target }}

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: bindings-${{ matrix.name }}
          path: packages/swc-transformer/src/native/*.node
          if-no-files-found: error
