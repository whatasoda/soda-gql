# NestJS with TypeScript Compiler Plugin Example

This example demonstrates using `@soda-gql/plugin-tsc` with the TypeScript compiler plugin (without webpack) for zero-runtime GraphQL transformations.

> **⚠️ Current Status (v0.1.0 Pre-release)**: The TypeScript compiler plugin is in minimal implementation state. It successfully detects `gql.default` calls with operations and establishes transformation infrastructure, but **does not yet perform full AST replacement**. Operations are still evaluated at runtime.

## Features

**Current Implementation (v0.1.0 pre-release)**:
- ✅ NestJS framework integration
- ✅ TypeScript compiler plugin infrastructure
- ✅ Detection of `gql.default` calls with operations
- ✅ Artifact loading and caching
- ✅ No webpack dependency required
- ✅ Works with `nest build` command
- ✅ Type-safe GraphQL operations
- ⏳ **Planned**: Zero-runtime transformation (AST replacement)

## Setup

```bash
# Install dependencies (from root)
bun install

# Generate GraphQL system files
cd playgrounds/nestjs-compiler-tsc
bun run codegen

# Generate artifact file
bun run artifact
```

## Usage

### Development Mode

```bash
bun run dev
```

This starts the NestJS development server. The TypeScript compiler plugin will:
- Detect `gql.default(({ operation }) => ...)` calls
- Load the pre-generated artifact file
- *(Planned for v0.1.0 final)* Transform calls to zero-runtime code

### Production Build

```bash
# Generate artifact
bun run artifact

# Build application
bun run build

# Start production server
bun run start
```

## Configuration

### nest-cli.json

The TypeScript compiler plugin is configured in `nest-cli.json`:

```json
{
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "builder": "tsc",
    "plugins": [
      {
        "name": "@soda-gql/plugin-tsc",
        "options": {
          "artifactPath": "./.cache/soda-gql-artifact.json",
          "mode": "zero-runtime",
          "importIdentifier": "@/graphql-system"
        }
      }
    ]
  }
}
```

### Plugin Options

- **artifactPath** (required): Path to the artifact file generated by the builder
- **mode** (optional): Transform mode - `"runtime"` or `"zero-runtime"` (default: `"runtime"`)
- **importIdentifier** (optional): Import identifier for GraphQL system (default: `"@/graphql-system"`)
- **configPath** (optional): Path to soda-gql config file

### Zero-Runtime Mode

When `mode: "zero-runtime"` is set, the plugin is configured for build-time transformation.

> **Note**: In the current v0.1.0 pre-release, transformation is not yet fully implemented. The code below shows the intended behavior once transformation is complete.

**Before transformation:**
```typescript
import { gql } from '@/graphql-system';
import { userSlice } from './slices';

export const userQuery = gql.default(({ operation }) =>
  operation.query(
    {
      name: 'UserQuery',
    },
    () => ({
      user: userSlice.build(),
    }),
  ),
);
```

**After transformation (planned for v0.1.0 final):**
```typescript
import { gqlRuntime } from '@/graphql-system';

export const userQuery = gqlRuntime.operation({
  type: 'query',
  name: 'UserQuery',
  document: 'query UserQuery { user { id name } }',
  variables: []
});
```

## Project Structure

```
nestjs-compiler-tsc/
├── src/
│   ├── graphql/
│   │   └── operations.ts      # GraphQL operations
│   ├── services/
│   │   └── user.service.ts    # Business logic with soda-gql
│   ├── app.module.ts          # NestJS module
│   └── main.ts                # Application entry
├── graphql-system/
│   └── index.ts               # Generated by codegen
├── schema.graphql             # GraphQL schema
├── nest-cli.json              # NestJS CLI with compiler plugin config
├── soda-gql.config.ts         # soda-gql configuration
├── package.json
└── tsconfig.json
```

## Workflow

### 1. Generate GraphQL System

```bash
bun run codegen
```

This generates type-safe GraphQL system from your schema.

### 2. Write Operations

Create GraphQL operations in `src/graphql/operations.ts`:

```typescript
import { gql } from '@/graphql-system';
import { userSlice } from './slices';

export const getUserQuery = gql.default(({ operation }, { $var }) =>
  operation.query(
    {
      name: 'GetUser',
      variables: [$var('userId').scalar('ID:!')],
    },
    ({ $ }) => ({
      user: userSlice.build({ id: $.userId }),
    }),
  ),
);
```

### 3. Generate Artifact

```bash
bun run artifact
```

This analyzes your code and generates the artifact file needed for transformation.

### 4. Build Application

```bash
bun run build
```

The TypeScript compiler plugin detects operations and prepares for transformation (full AST replacement planned for v0.1.0 final).

### 5. Run Application

```bash
bun run start
```

## Comparison with Webpack Plugin

### TypeScript Compiler Plugin (This Example)

**Current Status (v0.1.0 pre-release)**:
- ✅ No webpack dependency
- ✅ Works with standard `nest build` command
- ✅ Simpler configuration
- ✅ Detection and infrastructure in place
- ⏳ Zero-runtime transformation planned

**Limitations**:
- ⚠️ Requires pre-generating artifact file
- ⚠️ No built-in watch mode for artifact regeneration
- ⚠️ No AST transformation yet (detection-only)

### Webpack Plugin

**Current Status** *(fully functional)*:
- ✅ Complete zero-runtime transformation
- ✅ Integrated watch mode
- ✅ Automatic artifact generation
- ✅ Error reporting in development

**Considerations**:
- ⚠️ Requires webpack
- ⚠️ More complex configuration

## Scripts

```json
{
  "codegen": "soda-gql codegen --schema:default ./schema.graphql --out ./graphql-system/index.ts --scalar:default ./inject-module/runtime-adapter.ts --runtime-adapter:default ./inject-module/runtime-adapter.ts",
  "artifact": "soda-gql builder --mode zero-runtime --entry ./src/**/*.ts --out ./.cache/soda-gql-artifact.json",
  "build": "nest build",
  "dev": "nest start --watch",
  "start": "node dist/main"
}
```

## Troubleshooting

### Artifact Not Found

```
[@soda-gql/plugin-tsc] Transform preparation failed (ARTIFACT_NOT_FOUND)
```

**Solution:** Run the artifact generation command:
```bash
bun run artifact
```

### Plugin Not Applying Transformations

**Causes:**
1. Wrong mode configured (ensure `mode: "zero-runtime"`)
2. Artifact is stale or missing
3. Import identifier doesn't match

**Debug:**
```bash
# Verify artifact exists
cat .cache/soda-gql-artifact.json

# Regenerate artifact
bun run artifact

# Rebuild
bun run build
```

### Type Errors

Ensure codegen has been run and GraphQL system is up to date:
```bash
bun run codegen
```

## Development Tips

1. **Watch Mode**: Use two terminals
   ```bash
   # Terminal 1: Watch artifact generation
   bun run artifact --watch

   # Terminal 2: Watch NestJS
   bun run dev
   ```

2. **Cache Clearing**: If transformations seem incorrect
   ```bash
   rm -rf .cache dist
   bun run artifact
   bun run build
   ```

3. **Verification**: Check transformed output
   ```bash
   cat dist/graphql/operations.js
   ```

## Next Steps

- Try the [Next.js webpack playground](../nextjs-webpack) for integrated development workflow
- Explore [advanced patterns](../../docs/guides) in the documentation
