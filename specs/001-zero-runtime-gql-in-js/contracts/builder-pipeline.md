# Contract — `soda-gql builder`

## Purpose
Traverse user code that imports the generated `gql` helpers, evaluate model/slice/page-query descriptors, and emit GraphQL documents plus dependency metadata for both runtime execution and zero-runtime transforms.

## Inputs
| Flag | Type | Required | Description |
|------|------|----------|-------------|
| `--mode` | Enum (`runtime` \| `zero-runtime`) | ✅ | Selects direct execution vs artifact-only output |
| `--entry` | Glob/Path | ✅ | Entry file(s) for analysis (e.g., `src/pages/**/*.ts`) |
| `--out` | Path (file) | ✅ | Destination JSON artifact containing docs, refs, diagnostics |
| `--format` | Enum (`json` \| `human`) | ❌ (default `human`) | CLI diagnostics format |
| `--watch` | Boolean | ❌ | Re-run when source files change |
| `--help` / `--version` | Boolean | ❌ | Standard Bun CLI flags |

## Successful Response (GREEN)
- Exit code `0`.
- Executes all reachable `gql.model`, `gql.querySlice`, and `gql.query` factories exactly once, resolving canonical identifiers of the form `{absPath}::{exportName}` for every definition.
- Writes artifact JSON with shape:
  ```json
  {
    "documents": {
      "ProfilePageQuery": {
        "text": "query ProfilePageQuery { ... }",
        "variables": { "userId": "ID!" }
      }
    },
    "refs": {
      "/abs/path/entities/user.ts::userModel": {
        "kind": "model",
        "hash": "...",
        "dependencies": []
      },
      "/abs/path/entities/user.ts::userSlice": {
        "kind": "slice",
        "canonicalDocument": "ProfilePageQuery"
      }
    },
    "report": {
      "documents": 1,
      "models": 3,
      "slices": 2,
      "durationMs": 72
    }
  }
  ```
- Emits warnings when slice count ≥16, errors when >32.
- In `--mode runtime`, also materialises the documents to disk for direct consumption by tests.

## Failure Cases (RED)
| Scenario | Expected Behavior |
|----------|------------------|
| Circular dependency detected | Exit `1`; error `{ code: "CIRCULAR_DEPENDENCY", chain: [...] }` |
| Duplicate document name | Exit `1`; error `{ code: "DOC_DUPLICATE", name, sources }` |
| Missing required parameter | Exit `1`; error `{ code: "PARAM_REQUIRED", id, argument }` |
| Invalid refs due to evaluation error | Exit `1`; include file path + export name |

## Contract Tests (to be written)
1. `builder_circular_dependency.test.ts` → Provide mock files forming cycle, expect `Result.err` with chain output (RED).  
2. `builder_duplicate_doc.test.ts` → Two slices returning same doc name; expect duplicate error.  
3. `builder_success_artifact.test.ts` → Integration fixture verifying artifact contents + metrics once implementation exists.

## Dependencies
- `packages/builder` (core pipeline)
- `packages/core` (type helpers for refs/docs)
- GraphQL schema metadata generated by `codegen`
