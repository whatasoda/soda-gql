# @soda-gql/plugin-nestjs

NestJS integration for soda-gql, enabling zero-runtime GraphQL query generation in your NestJS applications.

## Current Status

**Implementation Level**: ðŸ”¶ **Minimal (Detection-only)**

> âš ï¸ **Pre-release v0.1.0**: The compiler plugins (TypeScript/SWC) currently provide infrastructure and detection but **do not perform full AST transformation yet**. Operations are still evaluated at runtime. The webpack integration is fully functional.
>
> **What works today**:
> - âœ… Plugin infrastructure and Nest CLI integration
> - âœ… Detection of `gql.operation.*` calls
> - âœ… Artifact loading and caching
> - âœ… Full webpack integration (zero-runtime working)
>
> **Not yet implemented**:
> - âŒ AST replacement for compiler plugins (TSC/SWC)
> - âŒ Runtime code elimination in compiler plugins
> - âŒ Zero-runtime transformation in compiler plugins
>
> For detailed status and architecture, see [docs/status/plugin-nestjs.md](../../docs/status/plugin-nestjs.md).

## Overview

This package provides two integration paths for using soda-gql with NestJS:

1. **Compiler Plugins** (TypeScript/SWC) - Infrastructure for zero-runtime transformation during Nest CLI build *(detection-only in v0.1.0)*
2. **Webpack Integration** - Full zero-runtime transformation via webpack loader (when using `builder: "webpack"`)

> **Note**: The compiler plugin approach (TSC/SWC) currently establishes transformation infrastructure but does not yet perform AST replacement. For working zero-runtime transformation today, use the webpack integration.

## Prerequisites

Before using this plugin, you need:

1. **Generated artifact file** - Run the soda-gql builder to generate the artifact:
   ```bash
   bun run soda-gql builder --mode zero-runtime --entry ./src/**/*.ts --out ./dist/soda-gql-artifact.json
   ```

2. **GraphQL system entry** - Generate your typed GraphQL system:
   ```bash
   bun run soda-gql codegen --schema ./schema.graphql --out ./src/graphql-system.ts
   ```

## Installation

### Workspace Setup (Monorepo)

```bash
bun add -D @soda-gql/plugin-nestjs
```

### Standalone Project

```bash
bun add -D @soda-gql/plugin-nestjs
# Peer dependencies (if not already installed)
bun add -D typescript    # For tsc compiler plugin
```

## Configuration

### Compiler Plugin Options

All compiler plugins accept the same configuration options:

| Option | Type | Required | Default | Description |
|--------|------|----------|---------|-------------|
| `artifactPath` | `string` | âœ… | - | Path to the artifact file generated by the builder |
| `mode` | `"runtime" \| "zero-runtime"` | âŒ | `"runtime"` | Transform mode. Use `"zero-runtime"` for build-time transformation |
| `importIdentifier` | `string` | âŒ | `"@/graphql-system"` | Import identifier for your GraphQL system |
| `configPath` | `string` | âŒ | - | Path to soda-gql config file (if using) |

## Usage

### TypeScript Compiler Plugin (Nest CLI â‰¥10, builder: "tsc")

#### Option 1: nest-cli.json (Recommended)

Add the compiler plugin to your `nest-cli.json`:

```json
{
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "builder": "tsc",
    "plugins": [
      {
        "name": "@soda-gql/plugin-nestjs/compiler/tsc",
        "options": {
          "artifactPath": "./dist/soda-gql-artifact.json",
          "mode": "zero-runtime",
          "importIdentifier": "@/graphql-system"
        }
      }
    ]
  }
}
```

#### Option 2: tsconfig.json

Alternatively, add to your `tsconfig.json`:

```json
{
  "compilerOptions": {
    "plugins": [
      {
        "transform": "@soda-gql/plugin-nestjs/compiler/tsc",
        "artifactPath": "./dist/soda-gql-artifact.json",
        "mode": "zero-runtime",
        "importIdentifier": "@/graphql-system"
      }
    ]
  }
}
```

**Note**: The `tsconfig.json` approach works with TypeScript's plugin system, but may not be recognized by all tools. The `nest-cli.json` approach is preferred when using Nest CLI.

### SWC Compiler Plugin (Nest CLI â‰¥10, builder: "swc")

Add the SWC plugin to your `nest-cli.json`:

```json
{
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "builder": "swc",
    "swcPlugins": [
      [
        "@soda-gql/plugin-nestjs/compiler/swc",
        {
          "artifactPath": "./dist/soda-gql-artifact.json",
          "mode": "zero-runtime",
          "importIdentifier": "@/graphql-system"
        }
      ]
    ]
  }
}
```

### Webpack Integration (builder: "webpack")

See [@soda-gql/plugin-webpack](../plugin-webpack/README.md) for direct webpack configuration, or configure via `nest-cli.json`:

```json
{
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "builder": "webpack",
    "webpackConfigPath": "webpack.config.js"
  }
}
```

Then add the webpack loader in your `webpack.config.js`:

```javascript
module.exports = {
  module: {
    rules: [
      {
        test: /\.ts$/,
        use: [
          {
            loader: '@soda-gql/plugin-webpack',
            options: {
              artifactPath: './dist/soda-gql-artifact.json',
              mode: 'zero-runtime',
              importIdentifier: '@/graphql-system'
            }
          }
        ]
      }
    ]
  }
};
```

## How It Works

### Zero-Runtime Mode

When `mode: "zero-runtime"` is configured, the plugin is set up for build-time transformation of your GraphQL operations.

> **Current Status (v0.1.0)**: The webpack integration performs full transformation as shown below. The compiler plugins (TSC/SWC) currently detect operations but do not yet perform AST replacement. Transformation will be added in the final v0.1.0 release.

**Before transformation**:
```typescript
import { gql } from '@/graphql-system';

export const userQuery = gql.operation.query('UserQuery', ({ f }) => ({
  user: f.user({}, ({ f }) => ({
    id: f.id,
    name: f.name,
  })),
}));
```

**After transformation** *(webpack integration only)*:
```typescript
import { gqlRuntime } from '@/graphql-system';

export const userQuery = gqlRuntime.operation({
  type: 'query',
  name: 'UserQuery',
  document: 'query UserQuery { user { id name } }',
  variables: []
});
```

The transformed code uses a minimal runtime that doesn't include the builder functions, significantly reducing bundle size.

### Runtime Mode

When `mode: "runtime"` is configured (or omitted), the plugin performs no transformation. Your code uses the full GraphQL builder at runtime. This is useful for development or when you want maximum flexibility.

## Build Workflow

### Development (with watch mode)

```bash
# Terminal 1: Run soda-gql builder in watch mode
bun run soda-gql builder --mode zero-runtime --entry ./src/**/*.ts --out ./dist/soda-gql-artifact.json --watch

# Terminal 2: Run Nest CLI in watch mode
nest start --watch
```

The artifact will be regenerated whenever your GraphQL operations change, and the Nest CLI will pick up the changes and recompile.

### Production Build

```bash
# 1. Generate artifact
bun run soda-gql builder --mode zero-runtime --entry ./src/**/*.ts --out ./dist/soda-gql-artifact.json

# 2. Build with Nest CLI
nest build
```

## Examples

See the integration tests for working examples:

- **TypeScript Compiler**: [tests/integration/plugin-nestjs/compiler/tsc.test.ts](../../tests/integration/plugin-nestjs/compiler/tsc.test.ts)
- **SWC Compiler**: [tests/integration/plugin-nestjs/compiler/swc.test.ts](../../tests/integration/plugin-nestjs/compiler/swc.test.ts)
- **Test Fixtures**: [tests/fixtures/plugin-nestjs/compiler/](../../tests/fixtures/plugin-nestjs/compiler/)

## Troubleshooting

### Artifact not found error

```
[@soda-gql/plugin-nestjs] Transform preparation failed (ARTIFACT_NOT_FOUND): Artifact not found at /path/to/artifact.json
```

**Solution**: Ensure the artifact path is correct and the builder has been run:
```bash
bun run soda-gql builder --mode zero-runtime --entry ./src/**/*.ts --out ./dist/soda-gql-artifact.json
```

### Plugin not applying transformations (Compiler Plugins)

> **Note**: In v0.1.0 pre-release, compiler plugins (TSC/SWC) do not yet perform transformation - this is expected behavior. They currently detect operations and load artifacts but do not modify code. For working zero-runtime transformation, use the webpack integration.

**For webpack integration**, possible causes:

1. **Wrong mode**: Ensure `mode: "zero-runtime"` is set in plugin options
2. **Artifact stale**: Regenerate the artifact after code changes
3. **Import identifier mismatch**: Ensure `importIdentifier` matches your actual import path

**Debug steps**:
```bash
# Verify artifact exists and is valid JSON
cat ./dist/soda-gql-artifact.json | jq

# Check webpack build output
nest build --webpack --webpackPath webpack.config.js
```

### TypeScript plugin not recognized

If using `tsconfig.json` plugins and they're not working:

1. Use the `nest-cli.json` approach instead (recommended)
2. Ensure you're running the build through Nest CLI, not directly with `tsc`
3. Verify Nest CLI version â‰¥10 for compiler plugin support

## Verifying Setup

Run the integration tests to verify your setup works correctly:

```bash
# Test TypeScript compiler plugin
bun test tests/integration/plugin-nestjs/compiler/tsc.test.ts

# Test SWC compiler plugin
bun test tests/integration/plugin-nestjs/compiler/swc.test.ts
```

## Performance Considerations

- **Zero-runtime mode** *(webpack integration)*: Significantly reduces bundle size by eliminating builder code at runtime
- **Compiler plugins** *(v0.1.0)*: Currently establish infrastructure; performance benefits will come with AST replacement implementation
- **Caching**: The plugin caches artifact parsing, so repeated compilations are fast
- **Watch mode**: Artifact regeneration is incremental, only processing changed files

## Related Packages

- [@soda-gql/builder](../builder/README.md) - Artifact generation
- [@soda-gql/plugin-webpack](../plugin-webpack/README.md) - Webpack-specific integration
- [@soda-gql/plugin-shared](../plugin-shared/README.md) - Shared plugin utilities

## License

MIT
