# @soda-gql/plugin-next

Next.js integration for soda-gql zero-runtime GraphQL transformations.

## Installation

```bash
bun add -D @soda-gql/plugin-next
```

## Usage

### Basic Setup

Add the plugin to your `next.config.js`:

```javascript
import { withSodaGql } from '@soda-gql/plugin-next';

export default withSodaGql({
  // Your Next.js config
  reactStrictMode: true,
}, {
  // soda-gql options
  configPath: './soda-gql.config.ts'
});
```

### TypeScript Configuration

For TypeScript configs (`next.config.ts` or `next.config.mjs`):

```typescript
import { withSodaGql } from '@soda-gql/plugin-next';
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  reactStrictMode: true,
  // ... other options
};

export default withSodaGql(nextConfig, {
  configPath: './soda-gql.config.ts'
});
```

### With Existing SWC Plugins

The plugin preserves any existing SWC plugins:

```javascript
import { withSodaGql } from '@soda-gql/plugin-next';

export default withSodaGql({
  experimental: {
    swcPlugins: [
      ['@swc/plugin-styled-components', { displayName: true }]
    ]
  }
}, {
  configPath: './soda-gql.config.ts'
});
```

## Configuration

### Plugin Options

```typescript
type SodaGqlNextOptions = {
  /**
   * Path to soda-gql config file.
   * @default './soda-gql.config.ts'
   */
  configPath?: string;

  /**
   * Enable/disable the plugin.
   * @default true
   */
  enabled?: boolean;
};
```

### Example: Conditional Enablement

```javascript
import { withSodaGql } from '@soda-gql/plugin-next';

export default withSodaGql({
  // ... Next.js config
}, {
  configPath: './soda-gql.config.ts',
  enabled: process.env.NODE_ENV !== 'test'
});
```

## Compatibility

### Supported Next.js Versions

- Next.js 12.x (with SWC compiler)
- Next.js 13.x
- Next.js 14.x
- Next.js 15.x

### App Router and Pages Router

The plugin works with both:
- **App Router** (Next.js 13+): Full support
- **Pages Router**: Full support

## Features

- **Zero Runtime**: GraphQL operations are transformed at build time
- **SWC Integration**: Uses Next.js's built-in SWC compiler for fast builds
- **TypeScript**: Full TypeScript support
- **Source Maps**: Generates source maps for debugging
- **HMR Compatible**: Works seamlessly with Fast Refresh

## How It Works

The plugin integrates soda-gql with Next.js's SWC compiler:

1. During build and development, Next.js uses SWC to compile your code
2. The soda-gql SWC plugin is added to the compilation pipeline
3. Files containing `gql.` calls are transformed
4. GraphQL operations are replaced with runtime calls
5. Zero runtime overhead in production

## Project Structure

### App Router Example

```
my-next-app/
├── app/
│   ├── page.tsx                    # Uses GraphQL operations
│   └── users/
│       └── page.tsx                # Uses GraphQL operations
├── graphql-system/
│   └── index.ts                    # Generated by soda-gql
├── soda-gql.config.ts              # soda-gql configuration
├── next.config.js                  # Next.js config with plugin
└── package.json
```

### Pages Router Example

```
my-next-app/
├── pages/
│   ├── index.tsx                   # Uses GraphQL operations
│   └── users/
│       └── [id].tsx                # Uses GraphQL operations
├── graphql-system/
│   └── index.ts                    # Generated by soda-gql
├── soda-gql.config.ts              # soda-gql configuration
├── next.config.js                  # Next.js config with plugin
└── package.json
```

## Development Workflow

### 1. Generate GraphQL System

First, generate your GraphQL system:

```bash
bun soda-gql codegen
```

### 2. Start Development Server

```bash
bun dev
```

The plugin will automatically transform your GraphQL operations during compilation.

### 3. Build for Production

```bash
bun run build
```

## Troubleshooting

### Plugin Not Working

Ensure that:
1. You're using Next.js 12+ with SWC compiler enabled
2. The `configPath` points to a valid soda-gql config file
3. Your GraphQL schema is properly configured
4. The plugin is correctly wrapped around your Next.js config

### SWC Compiler Issues

If you encounter SWC compiler issues:
1. Verify that SWC is enabled (default in Next.js 12+)
2. Check for conflicting SWC plugins
3. Review Next.js console output for errors

### Build Errors

If you encounter build errors:
1. Run `bun typecheck` to verify TypeScript errors
2. Check that your soda-gql config is valid
3. Ensure the GraphQL system is generated
4. Review the Next.js build output for specific errors

### Babel Configuration

**Note**: This plugin uses SWC, not Babel. If you have a `.babelrc` file, Next.js will fall back to Babel compilation and the plugin won't work. To use this plugin:

1. Remove or rename your `.babelrc` file
2. Or use `@soda-gql/plugin-babel` instead

## Migration from Babel

If you're currently using `@soda-gql/plugin-babel` with Next.js:

1. Remove `@soda-gql/plugin-babel` from your Babel config
2. Install `@soda-gql/plugin-next`
3. Update your `next.config.js` to use `withSodaGql`
4. Remove your `.babelrc` file to enable SWC

## License

MIT
